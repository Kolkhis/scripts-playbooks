---
- name: Install, configure, and deploy Loki
  hosts: localhost
  vars:
    loki_version: 2.9.7
    loki_platform: linux-amd64
    loki_archive: "loki-{{ loki_platform }}.zip"
    gh_release_page: https://github.com/grafana/loki/releases/download
    loki_download_link: "{{ gh_release_page }}/v{{ loki_version }}/loki-{{ loki_platform }}.zip"
  tasks:

    - name: Set up the environment
      become: true
      block:

        - name: Make sure unzip is on the system
          ansible.builtin.package:
            name: unzip
            state: present

        - name: Make a directory to install Loki into
          ansible.builtin.file:
            path: /opt/loki
            mode: '0755'
            state: directory

        - name: Download the loki archive
          ansible.builtin.get_url:
            dest: /opt/loki
            url: "{{ loki_download_link }}"
            mode: '0755'

        - name: Extract the loki archive
          ansible.builtin.unarchive:
            remote_src: true
            src: "/opt/loki/{{ loki_archive }}"
            dest: /opt/loki
            mode: '0755'

        - name: Create the loki configuration file
          ansible.builtin.copy:
            mode: '0755'
            dest: /opt/loki/loki-local-config.yaml
            content: |
              auth_enabled: false

              server:
                http_listen_port: 3100
                grpc_listen_port: 9096
                log_level: debug
                grpc_server_max_concurrent_streams: 1000
                http_listen_address: 0.0.0.0  # Listen for connections from all IPs

              common:
                instance_addr: 127.0.0.1
                path_prefix: /tmp/loki
                storage:
                  filesystem:
                    chunks_directory: /tmp/loki/chunks
                    rules_directory: /tmp/loki/rules
                replication_factor: 1
                ring:
                  kvstore:
                    store: inmemory

              query_range:
                results_cache:
                  cache:
                    embedded_cache:
                      enabled: true
                      max_size_mb: 100

              limits_config:
                metric_aggregation_enabled: true
              schema_config:
                configs:
                  - from: 2020-10-24
                    store: tsdb
                    object_store: filesystem
                    schema: v13
                    index:
                      prefix: index_
                      period: 24h
              pattern_ingester:
                enabled: true
                metric_aggregation:
                  loki_address: localhost:3100
              ruler:
                alertmanager_url: http://localhost:9093
              frontend:
                encoding: protobuf
              # Disable sending stats to grafana labs
              analytics:
                reporting_enabled: false

    - name: Systemd operations and output
      become: true
      block:

        - name: Start and enable loki
          ansible.builtin.systemd:
            name: loki
            state: started
            enabled: true
            daemon_reload: true

        - name: Get the status of loki on the node
          ansible.builtin.systemd:
            name: loki
          register: loki_systemd_output_raw

        - name: Output the status of loki
          ansible.builtin.debug:
            msg:
              - "Loki status: {{ loki_systemd_output_raw.state.ActiveState }}"
              - "Loki endpoint for promtail: http://{{ ansible_default_ipv4.address }}:3100/loki/api/v1/push"
